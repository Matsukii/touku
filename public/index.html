<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="google" content="notranslate">
    <title>RocketChatto</title>

    <link rel="shortcut icon" href="/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css">
    <script src="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.min.js"></script>

    <style>
        /* @import url('https://fonts.googleapis.com/css?family=Actor&display=swap'); */
        @import url('https://fonts.googleapis.com/css?family=Catamaran&display=swap');
        *{
            font-family: 'Catamaran', sans-serif;
        }
        ::placeholder{
            color: #A79CC1;
        }
        .dark{
            --color-accent:      #30A0FF;
            --color-background:  #222222;
            --text-dark:         #CCCCCC;
            --text-light:        #A79CC1;
            --color-link:        #03A9F4;

            --color-primary:     #191919;
            --color-secondary:   #222222;
            --color-tertiary:    #2d2d2d;
            --color-quarternary: #333333;
        }
        .light{
            --color-accent:      #3C2963;
            --color-background:  linear-gradient(180deg, #F1F5F8 0%, #EBF3FA 0.01%, #DDE7F378 53.92%, #E6F0F9 100%), linear-gradient(180deg, #E8F0F7 3.43%, #E3EDF7 47.52%, #E3E7F7 100%);
            --text-dark:         #606060;
            --text-light:        #A79CC1;
            --color-link:        #03A9F4;

            --color-primary:     #FFFFFF;
            --color-secondary:   #FFFFFF;
            --color-tertiary:    #F1F1F1;
            --color-quarternary: #CECECE;
        }
        body{
            background: var(--color-background);
            color: var(--text-dark);
            margin: 0;
            height: 100vh;
        }
        textarea{
            background: var(--color-tertiary);
            border: none;
            border-radius: 8px;
            padding: 5px;
            width: 200px;
            height: 30px;
            color: var(--text-dark);
            font-size: 100%;
            width: -webkit-fill-available;
            resize: none;
            padding: 5px 15px 0px;
            background: linear-gradient(17.62deg, #ffffff61 -50.86%, #ecf1f700 19.28%, #cfdceb38 92.21%);
            box-shadow: inset 3px 3px 10px rgba(18, 46, 100, 0.2), inset -4px 0px 11px rgba(255, 255, 255, 0.7)
        }
        input{
            font-size: 100%;
            background: var(--color-tertiary);
            border: none;
            border-radius: 5px;
            padding: 0 15px;
            width: 200px;
            height: 30px;
            color: var(--text-dark);
        }
        input[type='checkbox']{
            width: 20px;
            height: 20px;
            margin-top: 10px;
        }
        li{
            list-style: none;
        }
        li b{
            letter-spacing: 0.3px;
        }
        ul{
            padding-left: 10px;
        }
        label[acc]{
            color: var(--color-accent);
            font-weight: 600;
        }
        b[local]{
            color: var(--color-accent);
        }
        a{
            text-decoration: none;
            color: var(--color-link);
        }

        a[onlineCounter]{
            color: var(--color-accent);
        }

        button[send]{
            border: none;
            padding: 0px 10px;
            margin-left: 10px;
            border-radius: 10px;
            background: var(--color-background);
            color: var(--color-accent);
            font-variant: all-small-caps;
            font-size: 100%;
            background: linear-gradient(0deg, #E3EDF7, #E3EDF7);
            box-shadow: 2px 4px 10px #88a5bf55, -2px -2px 10px #ffffff

        }

        .inputs{
            padding: 5px 15px 0px;
            background: linear-gradient(17.62deg, #ffffff61 -50.86%, #ecf1f700 19.28%, #cfdceb38 92.21%);
            box-shadow: inset 3px 3px 10px rgba(18, 46, 100, 0.2), inset -4px 0px 11px rgba(255, 255, 255, 0.7);
            color: var(--color-accent);
        }

        #app{
            height: 90%;
        }
        .chatt-main-container{
            max-width: 400px;
            margin: auto;
            display: flex;
            height: 100%;
            flex-direction: column;
            padding: 15px;
        }
        .cm-minibar-container{
            margin: 15px 0px 0px;
            background: var(--color-background);
            border-radius: 10px;
            height: 20px;
            padding: 13px 15px 5px;
            display: flex;
            flex-direction: column-reverse;
            background: linear-gradient(0deg, #E3EDF7, #E3EDF7);
            box-shadow: 4px 4px 16px #88a5bf55, -2px -2px 15px  #ffffff
        }
        .pm-minibar-container{
            margin: 15px 0px 0px;
            /* background: var(--color-background); */
            border-radius: 10px;
            height: 20px;
            padding: 13px 15px 5px;
            display: flex;
            /* flex-direction: column-reverse; */
            /* background: linear-gradient(0deg, #E3EDF7, #E3EDF7); */
            /* /* box-shadow: 4px 4px 16px #88a5bf55, -2px -2px 15px #ffffff; */
        }
        .cm-minibar-container b{
            /* margin-bottom: -8px; */
      
        }
        .pm-minibar-container b{
            /* margin-bottom: -zpx; */
            font-size: 170%;
            font-weight: 300;
            margin: auto;
            margin-top: -14px;
            color: var(--color-accent);
            letter-spacing: 1.1px;
        }
        .cm-minibar-container img{
            align-self: flex-end;
            margin-bottom: -21px;
            max-width: 16px;
            cursor: pointer;
            
        }

        .cm-messages-main-container{
            height: 100%;
            /* overflow-y: scroll; */
        }
        .cm-inout-container{
            display: flex;
        }

        .pf-back-icon{
            align-self: flex-end;
            margin-bottom: -5px;
            max-width: 35px;
            border-radius: 10px;
            cursor: pointer;
            position: absolute;
            /* margin-right: 150px; */
            box-shadow: 3px 4px 11px #88a5bf52, -4px -4px 12px #ffffffd1;
            align-self: center;
            margin-top: -5px;
        }


        .pmp-edit-cont{
            display: flex;
            flex-direction: column;
        }

        .pmp-edit-cont label{
            margin-left: 10px;
            color: var(--color-accent);
            margin-top: 10px;
        }
        .pmp-edit-cont .pmp-newname-input{
            border-radius: 8px;
            font-size: 110%;
        }
        .pmp-edit-cont .pmp-color-input{
            border-radius: 8px;
            max-width: 150px;
            font-size: 110%;
        }

        .pmp-color-input:focus, .pmp-newname-input:focus{
            box-shadow: 3px 4px 11px #88a5bfc2, -4px -4px 12px #fffffffa;
            transition: all 0.3s ease-in-out;
            outline: none;
        }

        #colorInDisp{
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--color-accent);
            padding: 0;
            margin: 0;
            color: var(--color-accent);
            display: inline-flex;
            position: absolute;
            margin-left: 20px;
            box-shadow: 3px 4px 11px #88a5bfc2, -4px -4px 12px #fffffffa;
            cursor: pointer;
            /* user-select: none; */
        }
    </style>
    
</head>
<body class="light">
    <!-- konnichiwa
    The actual favicon is from Coding planets app, <br>
    it is temorary untuil i create one, <br>
    it was the mos similar to an icon i could find quickly -->

    <div id="app">
        <div class="chatt-main-container" id="messager-container" >

            <div class="cm-minibar-container">
                <b>
                    online: <a onlineCounter>{{counter}}</a>
                </b>
                <img src="/icons/profile.svg" alt="profile icon" v-on:click="showChatto = !showChatto">

            </div>
            
            <div id="msgs" class="cm-messages-main-container">
                <div class="cm-messages-sub-container">
                    <ul id="messages"> </ul>
                </div>
            </div>

            <div class="cm-inout-container">
                <textarea
                    type="text"
                    v-on:keyUp="checkckey"
                    v-model="message"
                    id="msg"
                    placeholder="Type a message"
                ></textarea>
                
                <button send v-on:click="sendMessage">Send</button>
            </div>
            <a>{{warningMessage}}</a>
            
        </div>
      
        <div class="profile-main-container chatt-main-container" v-if="!showChatto">
            <div class="pm-minibar-container">
                <img src="/icons/arrowLeft.svg" class="pf-back-icon" alt="profile icon" v-on:click="showChatto = !showChatto">
                <b> Profile </b>
            </div>

            <div class="pm-profile-cont">
                <img src="" alt="profile image">
                <p><b>{{user}}</b></p>

                <div class="pmp-edit-cont">
                    <label for="nnewNameIn">Nickname</label>
                    <input
                        type="text"
                        v-bind:placeholder="user"
                        v-model="newUserName"
                        id="nnewNameIn"
                        spellcheck="false"
                        class="inputs pmp-newname-input"
                    > 

                    <label for="nnewNameIn">Color</label>
                    <div>
                        <input
                            type="text"
                            v-bind:placeholder="'#3C2963' || color"
                            v-model="color"
                            id="colorIn"
                            spellcheck="false"

                            class="inputs pmp-color-input"
                            maxlength="9"
                        >
                        <div id="colorInDisp"></div>

                    </div>
                    

                </div>
            </div>
        </div>


    </div>
    
    
    <!-- <button v-on:click="clearMessages">Clear messages</button> -->
    
    
    <!-- <label for="sendwentr" style="vertical-align: super;" title="chet to show as image">the text is a image link</label>
    <input type="checkbox" v-model="isImage" name="sendWithEnter" id="sendwentr">
    <br>         -->
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
    <script src="/mobileCheck.js"></script>
    <script src="/favico-0.3.10.min.js"></script>
    <script>
        if(Notification.permission != "granted"){
            Notification.requestPermission();
        }
        let hasUnreadInterval;

        var favicon = new Favico({
            position  :'up',
            animation :'fade',
            bgColor   :'#dd2c00',
            textColor :'#dd2c00'
        });

        io = io();
        app = new Vue({
            el: '#app',
            data:{
                message:'',
                warningMessage: '',
                modf: false,
                showChatto: true,
                user: localStorage.name || 'Anon',
                newUserName: 'Anon',
                counter: 0,
                saveNewNameHidden: false,
                enterSend: false,
                isImage: false,
                isVideo: false,
                sendedCounter: 0,
                hasUnreadMessage: false,
                docVisible: true,
                color: '#03A9F4'
            },
            computed:{
            },
            created(){
                // this.user = prompt("Your name");
                this.user = localStorage.name || `Anon#${this.genRandCode()}`
                this.newUserName = this.user;
                io.emit('joined', {name: this.user});
                this.enterSend = sessionStorage.enterSend;
                document.addEventListener('visibilitychange', () => {
                    this.docVisible = document.visibilityState == 'visible'
                })
            },
            watch:{
                showChatto(val){
                    let msgCont = document.getElementById('messager-container');
                    if(val){
                        msgCont.style.display = ""
                    }
                    else {
                        msgCont.style.display = "none"

                    }
                },
                message(val){
                    if(val){
                        io.emit('typing', {user: this.user});
                        setTimeout(() => {
                            io.emit('typing', false);
                        }, 2000);
                    }
                },
                newUserName(val, old){
                    if(val == this.user){
                        this.saveNewNameHidden = false;
                    }
                    else{
                        this.saveNewNameHidden = true;
                    }
                },
                enterSend(val){
                    localStorage.setItem('enterSend', val);
                },
                docVisible(val){
                    if(!val && this.hasUnreadMessage){
                        favicon.badge(1);
                    }
                    else if(val && this.hasUnreadMessage){
                        setTimeout(() => {
                            this.hasUnreadMessage = false;
                            favicon.badge(0);
                        }, 1000);
                    }
                },
                hasUnreadMessage(val){
                    if(val){
                        hasUnreadInterval = setInterval(() => {
                            favicon.badge(1);
                        }, 60000);
                    }
                    else{
                        clearInterval(hasUnreadInterval);
                        favicon.badge(0);
                        try {
                            notfy.close();
                        } catch (e) {}
                    }
                }
            },
            methods:{
                genRandCode: function(){
                    rand = (Math.random()+1).toString(36).substr(7);
                    if(rand.length >= 7 || rand.length <= 5){
                        this.genRandCode();
                    }
                    this.code = rand;
                    return rand;
                },
                sendMessage: function(){
                    if(this.message.length > 0){
                        if(this.isImage){
                            io.emit('chatt', {user: this.user, message: this.message, type: 'img'});
                            false ? io.emit('chatt', {
                                user: {nick: this.user}, message: this.message, type: 'img'}):null;
                            this.isImage = false;
                        }
                        if(this.isImage){
                            io.emit('chatt', {user: this.user, message: this.message, type: 'vid'});
                            this.isVideo = false;
                        }
                        else{
                            io.emit('chatt', {user: this.user, message: this.message, color: this.color});
                        }
                        this.message = '';
                    }
                    if(isMobile){
                        document.getElementById('msg').focus();
                    }
                },
                checkckey: function(e){
                    e = e || window.event;
                    if (e.keyCode == 13 && !e.shiftKey && this.enterSend){
                        this.sendMessage();
                    }
                    else if(e.ctrlKey && e.keyCode == 13){
                        this.sendMessage()
                    }
                    
                },
                changeName: function(){
                    // io.emit('checkName', {new: this.newUserName, code: this.genRandCode()});
                    // io.once('checkName', name => {
                    //     if (name.avaliable){
                    //     }
                    // })
                    Cookies.set('name', this.newUserName, {domain: `.${window.location.host}`});
                    localStorage.setItem('name', this.newUserName)
                    io.emit('newName', {from: this.user, to: this.newUserName});
                    this.user = this.newUserName;
                },
                clearMessages: function(){
                    document.getElementById('messages').innerHTML = ''
                }
            }
        });

   
        let urlReg = new RegExp(/((http||https):\/\/?)([0-9a-z]*.){1,}/gi);

        const messages = document.getElementById('messages');
        io.on('count', count => app.counter = count.count)
        
        let showNotification;

        io.on('chatt', msg => {
            // console.log(msg);
            const listItem = document.createElement('li');


            if(showNotification) clearTimeout(showNotification);
            showNotification = setTimeout(() => {
                if(msg.user != app.user && app.hasUnreadMessage){
                    notfy = new Notification(`New message from ${msg.user}`, {
                        body: msg.message,
                        
                    });
                    if (msg.type == 'img'){
                        notfy.image = msg.message;
                    }
                    notfy.onclick = () => {
                        window.open(window.location.href);
                        setTimeout(() => {
                            notfy.close();
                        }, 200);
                    }
                }
            }, 1000);


            if(msg.type == 'img'){
                // listItem.innerHTML = `<b ${app.user == msg.user ? 'local': 'remote'}>${msg.user}</b>: <br> <img width="300px" src="${msg.message}">`;
                // listItem.innerHTML = `<b style="color:${msg.color}">${msg.user}</b>: <br> <img width="300px" src="${msg.message}">`;
                listItem.innerHTML = `<b ${app.user == msg.user ? 'style="color:${msg.color}"' : 'remote'}>${msg.user}</b>: <br> <img width="300px" src="${msg.message}">`;
            }
            else if(msg.type == 'vid'){
                listItem.innerHTML = `<b style="color:${msg.color}">${msg.user}</b>: <br> <iframe width="300px" src="${msg.message}"></iframe>`;
            }
            else if(msg.rawhtml){
                listItem.innerHTML = `<b style="color:${msg.color}">${msg.user}</b>: <br> ${msg.message}`;
            }
            else{
                msg.message = urlReg.test(msg.message) ? `<a href="${msg.message}" target="blank">${msg.message}</a>`: msg.message;
                // listItem.innerHTML = `<b ${app.user == msg.user ? 'style="color:'+msg.color+'"' : 'remote'}>${msg.user}</b>: ${msg.message}`;
                listItem.innerHTML = `<b style="color:${msg.color}">${msg.user}</b>: ${msg.message}`;
            }
            // new Notification(`${msg.user}: ${msg.message}`);
            messages.appendChild(listItem);
            // $('#messages').append($('<li>').text(`${msg.user}: ${msg.message}`));
            
         

            if(document.visibilityState == "hidden"){
                app.hasUnreadMessage = true;
            }
          
            
            // text box bottom, scroll to end
            // window.scrollTo(0, document.body.scrollHeight);

            // text box on top, scroll to top;
            spb.getScrollElement().scrollTo(0, 99999);

            window.scrollTo(0, 0);
        });

        // io.on('chatt_image', img => {
        //     const listItem = document.createElement('li');
        //     listItem.innerHTML = `<b ${app.user == msg.user ? 'local': 'remote'}>${msg.user}</b>: <br> <img src="${msg.message}">`;
        //     messages.appendChild(listItem);
        //     // $('#messages').append($('<li>').text(`${msg.user}: ${msg.message}`));
        //     window.scrollTo(0, document.body.scrollHeight);
        // })

        io.on('joined', user => {
            // console.log(user);
            const listItem = document.createElement('li');
            listItem.innerHTML = `${user.name} joined`;
            listItem.style.textAlign = 'center';
            listItem.style.color = 'var(--text-light)';

            messages.appendChild(listItem);
            // $('#messages').append($('<li>').text(`${msg.user}: ${msg.message}`));
            spb.getScrollElement().scrollTo(0, 99999);

            window.scrollTo(0, document.body.scrollHeight);
        })

        io.on('newName', user => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `${user.from} changed name to ${user.to}`;
            listItem.style.textAlign = 'center';
            listItem.style.color = 'var(--text-light)';

            messages.appendChild(listItem);
            // console.log(user);
            // window.scrollTo(0, document.body.scrollHeight);
            // spb.getScrollElement().scrollTop = 99999
            spb.getScrollElement().scrollTo(0, 99999);

            document.getElementById('msgs').scrollTo(0, document.getElementById('msgs').offsetHeight);
        })

        

        io.on('typing', is => {
            let remove = (str) => {
                setTimeout(() => {
                    if(str == 0){
                        document.title = "RocketChatto";
                    }
                    else if(str == 1){
                        app.warningMessage = '';
                    }
                }, 1000);
            }

            document.title = is ? `${is.user} is typing` : remove('RocketChatto');
            app.warningMessage = is && is.user != app.user ? `${is.user} is typing` : remove('');
        })

        setTimeout(() => {
            spb = new SimpleBar(document.getElementsByClassName('cm-messages-main-container')[0]);
            // spb.getScrollElement().scrollTop = spb.el.offsetHeight
            setTimeout(() => {
                // spb.getScrollElement().scrollTo(0, 99999);
                // spb.getScrollElement().scrollTop = spb.el.scrollHeight + 99999999;
            }, 300);

        }, 50);


    </script>

</body>
</html>